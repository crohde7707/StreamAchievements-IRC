!function(e){var n={};function t(o){if(n[o])return n[o].exports;var s=n[o]={i:o,l:!1,exports:{}};return e[o].call(s.exports,s,s.exports,t),s.l=!0,s.exports}t.m=e,t.c=n,t.d=function(e,n,o){t.o(e,n)||Object.defineProperty(e,n,{enumerable:!0,get:o})},t.r=function(e){"undefined"!=typeof Symbol&&Symbol.toStringTag&&Object.defineProperty(e,Symbol.toStringTag,{value:"Module"}),Object.defineProperty(e,"__esModule",{value:!0})},t.t=function(e,n){if(1&n&&(e=t(e)),8&n)return e;if(4&n&&"object"==typeof e&&e&&e.__esModule)return e;var o=Object.create(null);if(t.r(o),Object.defineProperty(o,"default",{enumerable:!0,value:e}),2&n&&"string"!=typeof e)for(var s in e)t.d(o,s,function(n){return e[n]}.bind(null,s));return o},t.n=function(e){var n=e&&e.__esModule?function(){return e.default}:function(){return e};return t.d(n,"a",n),n},t.o=function(e,n){return Object.prototype.hasOwnProperty.call(e,n)},t.p="",t(t.s=0)}([function(e,n,t){e.exports=t(1)},function(e,n,t){const o=t(2).default,s=t(3),l=t(4),a=process.env.TKN,c=process.env.UN,r=process.env.CID,i=t(5).build,{chat:u,chatConstants:h}=new o({token:a,username:c});process.env.PORT;let d,p=[],f={},g={},I={},m={},b={},v={},y=[],S=e=>{let n=b[channel],t={channel:channel,achievementID:n,type:e.tags.msgId,userID:e.tags.userId};y.push(t)};u.connect(),u.on("PRIVMSG",e=>{((e,n,t)=>{if(f[e]["full-access"]&&v[e]){let o=v[e][t];o&&(console.log("we have listeners..."),o.forEach(e=>{let t=new RegExp(e.query),o=n.match(t);o&&console.log(o)}))}})(e.channel.substr(1),e.message,e.username)}),u.on("NOTICE/HOST_ON",e=>{e.channel&&(f[e.channel.toLowerCase()].online=!1)}),u.on("USERNOTICE/SUBSCRIPTION",e=>{let n=e.channel.substr(1);g[n]&&((e,n)=>{let t={channel:e,achievementID:g[e].achievement,tier:n.parameters.subPlan,userID:n.tags.userId};y.push(t)})(n,e),console.log("------- SUB -------"),console.log(e),console.log("-------------------")}),u.on("USERNOTICE/RESUBSCRIPTION",e=>{let n=e.channel.substr(1);I[n]&&((e,n)=>{let{cumulativeMonths:t,streakMonths:o,subPlan:s}=n.parameters;I[e].forEach(l=>{if(0===l.type&&Number.parseInt(l.query)<=o){console.log("  >>> Achievmenet earned: streak");let t={channel:e,type:n.tags.msgId,tier:s,userID:n.tags.userId,achievementID:l.achievement,streak:o};y.push(t)}else if(1===l.type&&Number.parseInt(l.query)<=t){let o={channel:e,type:n.tags.msgId,tier:s,userID:n.tags.userId,achievementID:l.achievement,cumulative:t};y.push(o)}})})(n,e),console.log(I[n]),console.log("------- SUB -------"),console.log(e),console.log("-------------------")}),u.on("USERNOTICE/SUBSCRIPTION_GIFT",e=>{let n=e.channel.substr(1);totalGifts=e.parameters.senderCount,m[n]&&m[n][totalGifts]&&((e,n,t)=>{let o=m[e][t],{months:s,recepientID:l,subPlan:a}=n.parameters,c={channel:e,achievementID:o.achievement,type:n.tags.msgId,gifterID:n.tags.userId,recepientID:recipientId,recepientTotalMonths:s,tier:a};y.push(c)})(n,e,totalGifts),console.log("------- SUB GIFT -------"),console.log(e),console.log("-------------------")}),u.on("USERNOTICE/SUBSCRIPTION_GIFT_COMMUNITY",e=>{e.channel.substr(1);console.log("------- SUB GIFT COMMUNITY -------"),console.log(e),console.log("-------------------")}),u.on("USERNOTICE/RAID",e=>{let n=e.channel.substr(1);b[n]&&S(n),console.log("------- RAID -------"),console.log(e),console.log("-------------------")});let N=(e,n)=>{let t,o,s=e.channel;if("add"===n)switch(e.code){case"0":g[s]=e;break;case"1":type=e.type,t=e.query,I[s]=I[s]||[],I[s].push(e);break;case"2":t=e.query,m[s]=m[s]||[],m[s].push(e);break;case"3":b[s]=e;break;case"4":o=e.bot,v[s]=v[s]||{},v[s][o]=v[s][o]||[];let n=i(e.query);e.query=n,v[s][o].push(e)}else if("update"===n)switch(e.code){case"0":g[s]=e;break;case"1":if(type=e.type,t=e.query,I[s]=I[s]||[],0===I[s].length)I[s].push(e);else{let n=I[s].findIndex(n=>{n.id,e.id});I[s].splice(n,1,e)}break;case"2":if(t=e.query,m[s]=m[s]||[],0===m[s].length)m[s].push(e);else{let n=m[s].findIndex(n=>{n.id,e.id});m[s].splice(n,1,e)}break;case"3":b[s]=e;break;case"4":o=e.bot,v[s]=v[s]||{},v[s][o]=v[s][o]||[];let n=i(e.query);if(e.query=n,0===v[s][o].length)v[s][o].push(e);else{let n=v[s][o].findIndex(n=>{n.id,e.id});v[s][o].splice(n,1,e)}}else if("remove"===n)switch(e.code){case"0":delete g[s];break;case"1":if(type=e.type,t=e.query,I[s]&&I[s].length>0){let n=I[s].findIndex(n=>{n.id,e.id});I[s].splice(n,1)}break;case"2":if(t=e.query,m[s]&&m[s].length>0){let n=m[s].findIndex(n=>{n.id,e.id});m[s].splice(n,1)}break;case"3":delete b[s];break;case"4":if(o=e.bot,v[s]&v[s][o]&&v[s][o].length>0){let n=v[s][o].findIndex(n=>{n.id,e.id});v[s][o].splice(n,1)}}};(()=>new Promise((e,n)=>{(d=l.connect(process.env.API_DOMAIN,{reconnection:!0})).emit("handshake",{name:"SAIRC"}),d.on("new-channel",e=>{f[e.name]={name:e.name,"full-access":e["full-access"],online:!1}}),d.on("new-listener",e=>{console.log("new-listener"),N(e)}),d.on("update-listener",e=>{console.log("update-listener"),N(e,"update")}),d.on("remove-listener",e=>{console.log("remove-listener"),N(e,"remove")}),d.on("become-gold",e=>{f[e]["full-access"]=!0}),d.on("remove-gold",e=>{f[e]["full-access"]=!1}),d.on("achievement-awarded",e=>{}),s.get(process.env.API_DOMAIN+"/api/irc/channels",{withCredentials:!0}).then(n=>{(p=n.data.channels).forEach(e=>{f[e.name]={name:e.name,"full-access":e["full-access"],online:!1}}),e()})}))().then(()=>{console.log("==========================="),console.log("   IRC IS UP AND RUNNING   "),console.log("==========================="),console.log("\n"),console.log("Channels to watch: "+p.length),console.log("\n"),(async()=>{let e,n=!0,t=0;for(;n;){let o=await s.get(process.env.API_DOMAIN+"/api/irc/listeners",{params:{limit:5,offset:t,total:e},withCredentials:!0});o.data.listeners.forEach(e=>{N(e,"add")}),e=o.data.total,o.data.offset?t=o.data.offset:n=!1}})(),T()});let O=e=>{u.connect().then(n=>{u.join(e).then(n=>{console.log("*************************"),console.log(">>> STREAM ACHIEVEMENTS IS WATCHING "+e),console.log("*************************"),f[e].online=!0}).catch(n=>{console.log("[33m%s[0m","issue joining channel"),failedToConnect.push(e)})}).catch(n=>{failedToConnect.push(e),console.log("[33m%s[0m","issue connecting to chat")})},T=async()=>{let e=Object.keys(f).filter(e=>!f[e].online),n=0,t=!0,o=[];for(;t;){let o=await s.get("https://api.twitch.tv/kraken/streams/",{params:{client_id:r,channel:e.join(),limit:50,offset:n}}),l=o.data.streams;l.length>0?(l.forEach(e=>{let n=e.channel.display_name.toLowerCase();O(n)}),o.data._links.next?n+=50:t=!1):(console.log("No streams online"),t=!1)}let l=o.length>0;for(;l;){let e=o.splice(0,o.length);setTimeout(()=>{e.forEach(O)},5e3),l=o.length>0}};setInterval(T,12e4),setInterval(()=>{if(y.length>0){let e=y.slice(0);y.splice(0,y.length),console.log("Sending "+e.length+" achievements..."),s({method:"post",url:process.env.API_DOMAIN+"/api/achievement/listeners",data:e}).then(e=>{console.log("achievements processed")})}},1e4)},function(e,n){e.exports=require("twitch-js")},function(e,n){e.exports=require("axios")},function(e,n){e.exports=require("socket.io-client")},function(e,n){let t={"{user}":/([a-zA-Z0-9_]+)/,"{target}":/([a-zA-Z0-9_]+)/,"{value}":/([0-9]+)/};e.exports={build:e=>{let n=Object.keys(t),o=e;return n.forEach(e=>{o=o.replace(new RegExp(e,"gi"),t[e].source)}),o}}}]);