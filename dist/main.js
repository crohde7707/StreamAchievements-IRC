!function(e){var t={};function s(n){if(t[n])return t[n].exports;var o=t[n]={i:n,l:!1,exports:{}};return e[n].call(o.exports,o,o.exports,s),o.l=!0,o.exports}s.m=e,s.c=t,s.d=function(e,t,n){s.o(e,t)||Object.defineProperty(e,t,{enumerable:!0,get:n})},s.r=function(e){"undefined"!=typeof Symbol&&Symbol.toStringTag&&Object.defineProperty(e,Symbol.toStringTag,{value:"Module"}),Object.defineProperty(e,"__esModule",{value:!0})},s.t=function(e,t){if(1&t&&(e=s(e)),8&t)return e;if(4&t&&"object"==typeof e&&e&&e.__esModule)return e;var n=Object.create(null);if(s.r(n),Object.defineProperty(n,"default",{enumerable:!0,value:e}),2&t&&"string"!=typeof e)for(var o in e)s.d(n,o,function(t){return e[t]}.bind(null,o));return n},s.n=function(e){var t=e&&e.__esModule?function(){return e.default}:function(){return e};return s.d(t,"a",t),t},s.o=function(e,t){return Object.prototype.hasOwnProperty.call(e,t)},s.p="",s(s.s=0)}([function(e,t,s){e.exports=s(1)},function(module,exports,__webpack_require__){const fs=__webpack_require__(2),TwitchClient=__webpack_require__(3).default,ChatClient=__webpack_require__(4).default,Cryptr=__webpack_require__(5),cryptr=new Cryptr(process.env.SCK),uuid=__webpack_require__(6),axios=__webpack_require__(7),io=__webpack_require__(8),token=process.env.TKN,username=process.env.UN,client_id=process.env.CID,{build:build,getCondition:getCondition}=__webpack_require__(9),port=process.env.PORT||5e3;let socket,twitchClient,chat,channelStatus={},followListeners={},donationListeners={},bitsListeners={},subListeners={},resubListeners={},giftSubListeners={},raidListeners={},chatListeners={},connectedBots={},socketLookup={},requestQueue=[],failedToConnect=[],DEBUG_ENABLED=!1,debugLog=e=>{(DEBUG_ENABLED||process.env.DEBUG_ENABLED)&&console.log("(i) "+e)},newSubHandler=(e,t,s)=>{let{plan:n}=t,o=s.tags.get("user-id");subListeners[e]&&subListeners[e].forEach(t=>{if(t.condition===n){let s={channel:e,achievementID:t.achievement,tier:n,userID:o};requestQueue.push(s)}})},newFollowHandler=(e,t)=>{if(followListeners[e]){let s={channel:e,achievementID:followListeners[e].achievement,userID:t[0].id,user:t[0].name};requestQueue.push(s)}},donationHandler=(e,t)=>{if(donationListeners[e]){let s={channel:e,achievementID:donationListeners[e].achievement,user:t[0].name,amount:t[0].amount};requestQueue.push(s)}},bitsHandler=(e,t)=>{if(bitsListeners[e]){let s={channel:e,achievementID:bitsListeners[e].achievement,user:t[0].name};requestQueue.push(s)}},resubHandler=(e,t,s)=>{let n,{months:o,streak:i,plan:r}=t,a=s.tags.get("msg-id"),c=s.tags.get("user-id");if(resubListeners[e]){if(resubListeners[e].forEach(e=>{if(Number.parseInt(e.condition)<=o)if(n){let t=o-Number.parseInt(n.condition);o-Number.parseInt(e.condition)<t&&(n=e)}else n=e}),n){let t={channel:e,type:a,tier:r,userID:c,achievementID:n.achievement,cumulative:o};debugLog("Resub Achievement"),debugLog(JSON.stringify(t)),requestQueue.push(t)}}else subListeners[e]&&newSubHandler(e,t,s)},giftCommunitySubHandler=(e,t,s,n)=>{let o=giftSubListeners[e],{plan:i}=t,r=s.tags.get("msg-id"),a=s.tags.get("user-id");o.forEach(t=>{if(t.condition<=n){let s={channel:e,achievementID:t.achievement,type:r,userID:a,tier:i};debugLog("Community Sub Achievement"),debugLog(JSON.stringify(s)),requestQueue.push(s)}})},giftSubHandler=(e,t,s,n)=>{let o=giftSubListeners[e],{months:i,plan:r}=t,a=s.tags.get("msg-id"),c=s.tags.get("user-id");o.forEach(t=>{if(t.condition<=n){let s={channel:e,achievementID:t.achievement,type:a,userID:c,tier:r};debugLog("Gift Sub Achievement"),debugLog(JSON.stringify(s)),requestQueue.push(s)}}),awardRecipient(e,t,s)},awardRecipient=(e,t,s)=>{if(void 0!==s){let{months:n,plan:o}=t,i=(s.tags.get("msg-id"),s.tags.get("msg-param-recipient-id"));if(n>1){if(console.log("got some resub listeners, check them..."),resubListeners[e]){let t;if(resubListeners[e].forEach(e=>{if(Number.parseInt(e.condition)<=n)if(t){let s=n-Number.parseInt(t.condition);n-Number.parseInt(e.condition)<s&&(t=e)}else t=e}),t){let s={channel:e,type:"resub",tier:o,userID:i,achievementID:t.achievement,cumulative:n};debugLog("Award Recipient of Gift Achievement"),debugLog(JSON.stringify(s)),requestQueue.push(s)}}}else if(1===n&&subListeners[e]){let t={channel:e,achievementID:subListeners[e].achievement,tier:o,userID:i};requestQueue.push(t)}}else console.log("msg isn't defined")},raidHandler=e=>{let t=raidListeners[channel],s={channel:channel,achievementID:t,type:e.tags.msgId,userID:e.tags.userId};requestQueue.push(s)},chatHandler=(channel,msg,username)=>{if(channelStatus[channel]&&chatListeners[channel]){let listeners=chatListeners[channel][username];listeners&&(channelStatus[channel]["full-access"]||(listeners=[listeners[0]]),listeners.forEach(listener=>{let regex=new RegExp(listener.query),matches=msg.match(regex);if(matches){let match=!0,user=matches.groups.user;if(listener.condition)if("occured"===listener.condition){let e={channel:channel,user:user,achievementID:listener.achievement};requestQueue.push(e)}else if(Array.isArray(listener.condition));else{let{condition:condition,operator:operator,solution:solution}=listener.condition;"="===operator&&(operator="===");let award=!1,desired=matches.groups[condition];if(desired)if("time"===condition){let desiredTime=desired.replace(/[\.,\s]*/g,""),solutionTime=solution.replace(/[\.,\s]*/g,"");debugLog("Time based achievement for "+channel+": "+user),debugLog("desiredTime: "+desiredTime),debugLog("solutionTime: "+solutionTime),debugLog(eval(desiredTime+operator+solutionTime)),award=eval(desiredTime+operator+solutionTime)}else isNaN(parseFloat(solution))?"==="===operator&&(award=desired===solution):award=eval(desired+operator+solution);if(award){let e={channel:channel,achievementID:listener.achievement,user:user};requestQueue.push(e)}}}}))}if(0===msg.indexOf("!sachievement award ")){let e=msg.substr(20).split(" "),t=e.shift(),s=e.join(" ");try{axios({method:"post",url:process.env.API_DOMAIN+"/api/achievement/award/chat",data:{user:username,target:t,achievement:s,channel:channel}})}catch(e){console.log(">>> Issue manually awarding through chat")}}};(async()=>{let e=await axios.get(process.env.API_DOMAIN+"/api/irc/init");if(e.data&&e.data.at&&e.data.rt){let t=cryptr.decrypt(e.data.at),s=cryptr.decrypt(e.data.rt),n=e.data.expires_in;twitchClient=await TwitchClient.withCredentials(process.env.IRCCID,t,void 0,{clientSecret:process.env.IRCCS,refreshToken:s,expiry:new Date(n)||0,onRefresh:async({accessToken:e,refreshToken:t,expiryDate:s})=>{let n=cryptr.encrypt(e),o=cryptr.encrypt(t),i=null===s?0:s.getTime();await axios.put(process.env.API_DOMAIN+"/api/irc/init",{at:n,rt:o,expires_in:i})}}),chat=await ChatClient.forTwitchClient(twitchClient),await chat.connect(),await chat.waitForRegistration(),chat.onPrivmsg((e,t,s)=>{chatHandler(e.substr(1).toLowerCase(),s,t)}),chat.onAction((e,t,s)=>{chatHandler(e.substr(1).toLowerCase(),s,t)}),chat.onSub((e,t,s,n)=>{let o=e.substr(1).toLowerCase();subListeners[o]&&newSubHandler(o,s,n),console.log("------- SUB -------"),console.log(s),console.log("-------------------")}),chat.onResub((e,t,s,n)=>{let o=e.substr(1).toLowerCase();resubListeners[o]&&resubHandler(o,s,n),console.log("------- RESUB -------"),console.log(s),console.log("-------------------")}),chat.onCommunitySub((e,t,s,n)=>{console.log("----- COMMUNITY SUB -----"),console.log(s),console.log("---------------------");let o=e.substr(1).toLowerCase(),i=s.gifterGiftCount;giftSubListeners[o]&&giftCommunitySubHandler(o,s,n,i)}),chat.onSubGift((e,t,s,n)=>{console.log("------- SUB GIFT -------"),console.log(s),console.log("-------------------");let o=e.substr(1).toLowerCase(),i=s.gifterGiftCount;0===s.gifterGiftCount?awardRecipient(o,s,n):giftSubListeners[e]&&giftSubHandler(o,s,n,i)}),chat.onBitsBadgeUpgrade((e,t,s,n)=>{console.log("------- BIT BADGE -------"),console.log(s),console.log("-------------------"),console.log(n)}),chat.onHost((e,t,s)=>{console.log("------- HOST -------"),console.log(`${e} has just hosted ${t}`),console.log("-------------------")});let o=async()=>{let e,t=!0,s=0;for(;t;){let n=await axios.get(process.env.API_DOMAIN+"/api/irc/channels",{params:{limit:50,offset:s,total:e},withCredentials:!0});n.data.channels.forEach(e=>{channelStatus[e.name]={name:e.name,"full-access":e["full-access"],connected:!1,bot:e.bot||!1}}),e=n.data.total,n.data.offset?s=n.data.offset:(t=!1,d())}},i=async()=>{let e,t=!0,s=0;for(;t;){let n=await axios.get(process.env.API_DOMAIN+"/api/irc/listeners",{params:{limit:50,offset:s,total:e},withCredentials:!0});n.data.listeners.forEach(e=>{r(e,"add")}),e=n.data.total,n.data.offset?s=n.data.offset:t=!1}console.log("> listeners retrieved")},r=(e,t)=>{let s,n=e.channel;if("add"===t)switch(e.achType){case"0":subListeners[n]=subListeners[n]||[],subListeners[n].push(e);break;case"1":resubListeners[n]=resubListeners[n]||[],resubListeners[n].push(e);break;case"2":giftSubListeners[n]=giftSubListeners[n]||[],giftSubListeners[n].push(e);break;case"3":raidListeners[n]=e;break;case"4":s=e.bot.toLowerCase(),chatListeners[n]=chatListeners[n]||{},chatListeners[n][s]=chatListeners[n][s]||[];let t=build(e.query);e.query=t;try{e.condition=getCondition(e.condition),chatListeners[n][s].push(e)}catch(t){console.log("Issue with loading condition for "+e.achievement)}break;case"5":followListeners[n]=e;break;case"6":donationListeners[n]=e;break;case"7":bitsListeners[n]=e}else if("update"===t)switch(e.achType){case"0":if(subListeners[n]=subListeners[n]||[],0===subListeners[n].length)subListeners[n].push(e);else{let t=subListeners[n].findIndex(t=>t.id===e.id);subListeners[n].splice(t,1,e)}break;case"1":if(resubListeners[n]=resubListeners[n]||[],0===resubListeners[n].length)resubListeners[n].push(e);else{let t=resubListeners[n].findIndex(t=>{t.id,e.id});resubListeners[n].splice(t,1,e)}break;case"2":if(giftSubListeners[n]=giftSubListeners[n]||[],0===giftSubListeners[n].length)giftSubListeners[n].push(e);else{let t=giftSubListeners[n].findIndex(t=>{t.id,e.id});giftSubListeners[n].splice(t,1,e)}break;case"3":raidListeners[n]=e;break;case"4":s=e.bot.toLowerCase(),chatListeners[n]=chatListeners[n]||{},chatListeners[n][s]=chatListeners[n][s]||[];let t=build(e.query);e.query=t;try{if(e.condition=getCondition(e.condition),0===chatListeners[n][s].length)chatListeners[n][s].push(e);else{let t=chatListeners[n][s].findIndex(t=>{t.id,e.id});chatListeners[n][s].splice(t,1,e)}}catch(t){console.log("Issue with loading condition for "+e.achievement)}break;case"5":followListeners[n]=e;break;case"6":donationListeners[n]=e;break;case"7":bitsListeners[n]=e}else if("remove"===t)switch(e.achType){case"0":if(subListeners[n]&&subListeners[n].length>0){let t=subListeners[n].findIndex(t=>t.id===e.id);subListeners[n].splice(t,1)}break;case"1":if(query=e.query,resubListeners[n]&&resubListeners[n].length>0){let t=resubListeners[n].findIndex(t=>{t.id,e.id});resubListeners[n].splice(t,1)}break;case"2":if(query=e.query,giftSubListeners[n]&&giftSubListeners[n].length>0){let t=giftSubListeners[n].findIndex(t=>{t.id,e.id});giftSubListeners[n].splice(t,1)}break;case"3":delete raidListeners[n];break;case"4":if(s=e.bot.toLowerCase(),chatListeners[n]&chatListeners[n][s]&&chatListeners[n][s].length>0){let t=chatListeners[n][s].findIndex(t=>{t.id,e.id});chatListeners[n][s].splice(t,1)}break;case"5":delete followListeners[n];break;case"6":delete donationListeners[n];break;case"7":delete bitsListeners[n]}};(()=>new Promise((e,t)=>{(socket=io.connect(process.env.SOCKET_DOMAIN,{reconnection:!0})).emit("handshake",{name:"SAIRC"}),socket.on("new-channel",e=>{console.log("-------------------------------"),console.log("["+e.name+"] New channel created!"),console.log("-------------------------------"),channelStatus[e.name]={name:e.name,"full-access":e["full-access"],connected:!1},a(e.name)}),socket.on("channel-update",e=>{console.log("-------------------------------"),console.log("["+e.old+"] has updated their channel name to "+e.new),console.log("-------------------------------"),c(e.old);let t=channelStatus[e.old];delete channelStatus[e.old],channelStatus[e.new]={name:e.new,"full-access":t,connected:!1},a(e.new)}),socket.on("new-listener",e=>{console.log("-------------------------------"),console.log("["+e.channel+"] Adding listener for "+e.achievement),console.log("-------------------------------"),r(e,"add")}),socket.on("update-listener",e=>{console.log("-------------------------------"),console.log("["+e.channel+"] Updating listener for "+e.achievement),console.log("-------------------------------"),r(e,"update")}),socket.on("remove-listener",e=>{console.log("-------------------------------"),console.log("["+e.channel+"] Removing listener for "+e.achievement),console.log("-------------------------------"),r(e,"remove")}),socket.on("become-gold",e=>{console.log("-------------------------------"),console.log("["+e+"] just gained gold status!"),console.log("-------------------------------"),channelStatus[e]&&(channelStatus[e]["full-access"]=!0)}),socket.on("remove-gold",e=>{console.log("-------------------------------"),console.log("["+e+"] just lost gold status!"),console.log("-------------------------------"),channelStatus[e]&&(channelStatus[e]["full-access"]=!1)}),socket.on("connect-bot",e=>{console.log("-------------------------------"),console.log("["+e.channel+"] just connected "+e.bot+"!"),console.log("-------------------------------"),l(e.channel,e)}),socket.on("disconnect-bot",e=>{console.log("-------------------------------"),console.log("["+e.channel+"] just disconnected "+e.bot+"!"),console.log("-------------------------------");let{channel:t,bot:s}=e;if(connectedBots[t]&&connectedBots[t][s]){let e=connectedBots[t][s],n=e.id;e.close(),delete connectedBots[t][s],delete socketLookup[n]}}),socket.on("delete-channel",e=>{c(e)}),socket.on("test",e=>{}),socket.on("achievement-awarded",e=>{debugLog(JSON.stringify(e)),chat.say(e.channel,e.message)}),socket.on("achievement-awarded-nonMember",e=>{debugLog(JSON.stringify(e)),chat.say(e.channel,e.message)}),e()}))().then(()=>{console.log("==========================="),console.log("   IRC IS UP AND RUNNING   "),console.log("==========================="),console.log("\n"),o(),i()});let a=e=>{chat.join(e).then(t=>{console.log("*************************"),console.log(">>> STREAM ACHIEVEMENTS IS WATCHING "+e),channelStatus[e].bot&&l(e,channelStatus[e].bot,!0),console.log("*************************"),channelStatus[e].connected=!0}).catch(t=>{console.log("[33m%s[0m","issue joining "+e+"'s channel"),failedToConnect.push(e)})},c=e=>{chat.part(e)},l=(e,t,s)=>{let{st:n,bot:o}=t,i=cryptr.decrypt(n),r=io.connect("https://sockets.streamlabs.com?token="+i,{reconnection:!0}),a=`>>> ${e} is now connected to ${o}`;s?console.log(a):(console.log("*************************"),console.log(a),console.log("*************************")),r.SAID=uuid(),u(e,r),socketLookup[r.SAID]=e,connectedBots[e]||(connectedBots[e]={}),connectedBots[e][o]=r},u=(e,t)=>{t.on("event",e=>{let s=socketLookup[t.SAID];if("donation"===e.type)donationHandler(s,e.message);else if("twitch_account"===e.for)switch(e.type){case"follow":newFollowHandler(s,e.message);break;case"bits":bitsHandler(s,e.message)}})},d=()=>{let e=Object.keys(channelStatus);e.length>0&&e.forEach(e=>{let t=e.toLowerCase();a(t)});let t=failedToConnect.length>0;for(;t;){let e=failedToConnect.splice(0,failedToConnect.length);setTimeout(()=>{e.forEach(a)},5e3),t=failedToConnect.length>0}};setInterval(()=>{if(requestQueue.length>0){let e=requestQueue.slice(0);requestQueue.splice(0,requestQueue.length),console.log("Sending "+e.length+" achievements..."),axios({method:"post",url:process.env.API_DOMAIN+"/api/achievement/listeners",data:e})}},1e4)}})()},function(e,t){e.exports=require("fs")},function(e,t){e.exports=require("twitch")},function(e,t){e.exports=require("twitch-chat-client")},function(e,t){e.exports=require("cryptr")},function(e,t){e.exports=require("uuid/v1")},function(e,t){e.exports=require("axios")},function(e,t){e.exports=require("socket.io-client")},function(e,t){let s={"{user}":/(?<user>[a-zA-Z0-9_]+)/,"{target}":/(?<target>[a-zA-Z0-9_]+)/,"{amount}":/(?<amount>[0-9,\.]+)/,"{total}":/(?<total>[0-9,\.]+)/,"{time}":/(?<time>[0-9,\.\s]+)/,"{ignore}":/(?<ignore>.+)/};e.exports={build:e=>{let t=Object.keys(s),n=e;return n=(e=>e.replace(/[.*+?^$()|[\]\\]/g,"\\$&"))(n),t.forEach(e=>{n=n.replace(new RegExp(e,"gi"),s[e].source)}),n},getCondition:e=>{if(""===e||void 0===e)return"occured";{let t=new RegExp(/(?<condition>[a-zA-Z0-9_]+)(?<operator>[=<>]+)(?<solution>[a-zA-Z0-9_,\.]+)/),s=e.match(t);return s.groups?s.groups:(console.log("error getting condition for the following: "+e),"error")}}}}]);