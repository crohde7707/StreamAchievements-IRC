!function(e){var n={};function o(t){if(n[t])return n[t].exports;var s=n[t]={i:t,l:!1,exports:{}};return e[t].call(s.exports,s,s.exports,o),s.l=!0,s.exports}o.m=e,o.c=n,o.d=function(e,n,t){o.o(e,n)||Object.defineProperty(e,n,{enumerable:!0,get:t})},o.r=function(e){"undefined"!=typeof Symbol&&Symbol.toStringTag&&Object.defineProperty(e,Symbol.toStringTag,{value:"Module"}),Object.defineProperty(e,"__esModule",{value:!0})},o.t=function(e,n){if(1&n&&(e=o(e)),8&n)return e;if(4&n&&"object"==typeof e&&e&&e.__esModule)return e;var t=Object.create(null);if(o.r(t),Object.defineProperty(t,"default",{enumerable:!0,value:e}),2&n&&"string"!=typeof e)for(var s in e)o.d(t,s,function(n){return e[n]}.bind(null,s));return t},o.n=function(e){var n=e&&e.__esModule?function(){return e.default}:function(){return e};return o.d(n,"a",n),n},o.o=function(e,n){return Object.prototype.hasOwnProperty.call(e,n)},o.p="",o(o.s=0)}([function(e,n,o){e.exports=o(1)},function(e,n,o){const t=o(2).default,s=o(3),l=o(4),c=process.env.TKN,a=process.env.UN,r=process.env.CID,i=o(5).build;console.log(c),console.log(a);const{chat:u,chatConstants:d}=new t({token:c,username:a});process.env.PORT;let h,g=[],f={},p={},I={},m={},b={},y={},v=[],N=e=>{let n=b[channel],o={channel:channel,achievementID:n,type:e.tags.msgId,userID:e.tags.userId};v.push(o)};u.connect(),u.on("PRIVMSG",e=>{((e,n,o)=>{if(f[e]["full-access"]&&y[e]){let t=y[e][o];t&&(console.log("we have listeners..."),t.forEach(e=>{let o=new RegExp(e.query),t=n.match(o);t&&console.log(t)}))}})(e.channel.substr(1),e.message,e.username)}),u.on("NOTICE/HOST_ON",e=>{e.channel&&(f[e.channel.toLowerCase()].online=!1)}),u.on("USERNOTICE/SUBSCRIPTION",e=>{let n=e.channel.substr(1);p[n]&&((e,n)=>{let o={channel:e,achievementID:p[e],tier:n.parameters.subPlan,userID:n.tags.userId};v.push(o)})(n,e),console.log("------- SUB -------"),console.log(e),console.log("-------------------")}),u.on("USERNOTICE/RESUBSCRIPTION",e=>{let n=e.channel.substr(1);I[n]&&((e,n)=>{let{cumulativeMonths:o,streakMonths:t,subPlan:s}=n.parameters;I[e].forEach(l=>{if(console.log(l),console.log("streakMonths: "+t),console.log("cumulativeMonths: "+o),0===l.type&&Number.parseInt(l.query)<=t){console.log("  >>> Achievmenet earned: streak");let o={channel:e,type:n.tags.msgId,tier:s,userID:n.tags.userId,achievementID:l,streak:t};v.push(o)}else if(1===l.type&&Number.parseInt(l.query)<=o){console.log("  >>> Achievmenet earned: cumulativeMonths");let t={channel:e,type:n.tags.msgId,tier:s,userID:n.tags.userId,achievementID:l,cumulative:o};v.push(t)}})})(n,e),console.log(I[n]),console.log("------- SUB -------"),console.log(e),console.log("-------------------")}),u.on("USERNOTICE/SUBSCRIPTION_GIFT",e=>{let n=e.channel.substr(1);totalGifts=e.parameters.senderCount,m[n]&&m[n][totalGifts]&&((e,n,o)=>{let t=m[e][o],{months:s,recepientID:l,subPlan:c}=n.parameters,a={channel:e,achievementID:t,type:n.tags.msgId,gifterID:n.tags.userId,recepientID:recipientId,recepientTotalMonths:s,tier:c};v.push(a)})(n,e,totalGifts),console.log("------- SUB GIFT -------"),console.log(e),console.log("-------------------")}),u.on("USERNOTICE/SUBSCRIPTION_GIFT_COMMUNITY",e=>{e.channel.substr(1);console.log("------- SUB GIFT COMMUNITY -------"),console.log(e),console.log("-------------------")}),u.on("USERNOTICE/RAID",e=>{let n=e.channel.substr(1);b[n]&&N(n),console.log("------- RAID -------"),console.log(e),console.log("-------------------")});let O=(e,n)=>{let o,t,s=e.channel;if("add"===n)switch(e.code){case"0":p[s]=e,console.log("new sub listener added for "+s);break;case"1":type=e.type,o=e.query,I[s]=I[s]||[],I[s].push(e),console.log("resub listener added for "+s);break;case"2":o=e.query,m[s]=m[s]||[],m[s].push(e),console.log("gift sub listener addef for "+s);break;case"3":b[s]=e;break;case"4":t=e.bot,y[s]=y[s]||{},y[s][t]=y[s][t]||[];let n=i(e.query);e.query=n,y[s][t].push(e)}else if("update"===n)switch(e.code){case"0":p[s]=e,console.log("new sub listener added for "+s);break;case"1":if(type=e.type,o=e.query,I[s]=I[s]||[],0===I[s].length)I[s].push(e);else{let n=I[s].findIndex(n=>{n.id,e.id});I[s].splice(n,1,e)}console.log("resub listener modified for "+s);break;case"2":if(o=e.query,m[s]=m[s]||[],0===m[s].length)m[s].push(e);else{let n=m[s].findIndex(n=>{n.id,e.id});m[s].splice(n,1,e)}console.log("gift sub listener addef for "+s);break;case"3":b[s]=e;break;case"4":t=e.bot,y[s]=y[s]||{},y[s][t]=y[s][t]||[];let n=i(e.query);if(console.log(n),e.query=n,0===y[s][t].length)y[s][t].push(e);else{let n=y[s][t].findIndex(n=>{n.id,e.id});y[s][t].splice(n,1,e)}}else if("remove"===n)switch(e.code){case"0":delete p[s];break;case"1":if(type=e.type,o=e.query,I[s]&&I[s].length>0){let n=I[s].findIndex(n=>{n.id,e.id});I[s].splice(n,1)}break;case"2":if(o=e.query,m[s]&&m[s].length>0){let n=m[s].findIndex(n=>{n.id,e.id});m[s].splice(n,1)}break;case"3":delete b[s];break;case"4":if(t=e.bot,y[s]&y[s][t]&&y[s][t].length>0){let n=y[s][t].findIndex(n=>{n.id,e.id});y[s][t].splice(n,1)}}};(()=>new Promise((e,n)=>{(h=l.connect(process.env.API_DOMAIN,{reconnection:!0})).on("new-channel",e=>{g.push(e)}),h.on("new-listener",e=>{O(e)}),h.on("update-listener",e=>{O(e,"update")}),h.on("remove-listener",e=>{O(e,"remove")}),h.on("become-gold",e=>{f[e]["full-access"]=!0}),h.on("remove-gold",e=>{f[e]["full-access"]=!1}),h.on("achievement-awarded",e=>{}),console.log(process.env.API_DOMAIN+"/api/irc/channels"),s.get(process.env.API_DOMAIN+"/api/irc/channels",{withCredentials:!0}).then(n=>{(g=n.data.channels).forEach(e=>{f[e.name]={name:e.name,"full-access":e["full-access"],online:!1}}),e()})}))().then(()=>{console.log("==========================="),console.log("   IRC IS UP AND RUNNING   "),console.log("==========================="),console.log("\n"),console.log("Channels to watch: "+g.length),console.log("\n"),(async()=>{let e=!0,n=0;for(;e;){let o=await s.get(process.env.API_DOMAIN+"/api/irc/listeners",{params:{limit:100,offset:n},withCredentials:!0});o.data.listeners.forEach(e=>{O(e,"add")}),o.data.offset?n=o.data.offset+n:e=!1}})(),T()});let S=e=>{u.connect().then(n=>{u.join(e).then(n=>{console.log("*************************"),console.log(">>> STREAM ACHIEVEMENTS IS WATCHING "+e),console.log("*************************"),f[e].online=!0}).catch(n=>{console.log("[33m%s[0m","issue joining channel"),failedToConnect.push(e)})}).catch(n=>{failedToConnect.push(e),console.log("[33m%s[0m","issue connecting to chat")})},T=async()=>{let e=Object.keys(f).filter(e=>!f[e].online),n=0,o=!0,t=[];for(;o;){console.log(e);let t=await s.get("https://api.twitch.tv/kraken/streams/",{params:{client_id:r,channel:e.join(),limit:50,offset:n}}),l=t.data.streams;l.length>0?(l.forEach(e=>{let n=e.channel.display_name.toLowerCase();S(n)}),t.data._links.next?n+=50:o=!1):(console.log("No streams online"),o=!1)}let l=t.length>0;for(;l;){let e=t.splice(0,t.length);setTimeout(()=>{e.forEach(S)},5e3),l=t.length>0}console.log(f)};setInterval(T,12e4),setInterval(()=>{if(v.length>0){console.log(v);let e=v.slice(0);v.splice(0,v.length),console.log("Sending "+e.length+" achievements..."),s({method:"post",url:process.env.API_DOMAIN+"/api/achievement/listeners",data:e}).then(e=>{console.log("achievements processed")})}else console.log("no achievements yet...")},1e4)},function(e,n){e.exports=require("twitch-js")},function(e,n){e.exports=require("axios")},function(e,n){e.exports=require("socket.io-client")},function(e,n){let o={"{user}":/([a-zA-Z0-9_]+)/,"{target}":/([a-zA-Z0-9_]+)/,"{value}":/([0-9]+)/};e.exports={build:e=>{let n=Object.keys(o),t=e;return n.forEach(e=>{t=t.replace(new RegExp(e,"gi"),o[e].source)}),t}}}]);